<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Analog Piano Synth</title>
  <script src="https://cdn.jsdelivr.net/npm/nexusui@2.0.11/dist/NexusUI.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0D2A35;
      color: #A1D4B1;
      margin: 0;
      padding: 0;
      text-align: center;
    }

    h1 {
      color: #F1A512;
      margin-top: 20px;
    }

    #keyboard {
      margin: 20px auto;
      max-width: 700px;
    }

    .key {
      display: inline-block;
      width: 40px;
      height: 150px;
      margin: 1px;
      background: #A1D4B1;
      border: 2px solid #2BAF90;
      color: #0D2A35;
      line-height: 150px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .key.active {
      background: #F1A512;
    }

    canvas {
      display: block;
      margin: 20px auto;
      border: 2px solid #2BAF90;
      background: #000;
      border-radius: 6px;
    }

    .ui-panel {
      background: #2BAF90;
      padding: 20px;
      border-radius: 10px;
      width: 80%;
      margin: 20px auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }

    .ui-panel h3 {
      color: #0D2A35;
    }

    .knob-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 30px;
      padding: 10px;
    }

    .toggle-container {
      margin: 20px;
    }

    .nexusui {
      margin: auto;
    }
  </style>
</head>
<body>
  <h1>Analog Piano Synth</h1>

  <div class="ui-panel">
    <h3>Synth Controls</h3>
    <div id="knobs" class="knob-container"></div>

    <div class="toggle-container">
      <label for="waveToggle">Toggle Waveform:</label>
      <select id="waveToggle">
        <option value="sine">Sine</option>
        <option value="square">Square</option>
        <option value="triangle">Triangle</option>
        <option value="sawtooth">Sawtooth</option>
      </select>
    </div>
  </div>

  <div id="keyboard"></div>
  <canvas id="oscilloscope" width="800" height="150"></canvas>
  <canvas id="frequency" width="800" height="150"></canvas>

  <script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    const gainNode = audioCtx.createGain();
    analyser.connect(gainNode);
    gainNode.connect(audioCtx.destination);

    const knobConfig = [
      { id: 'volume', label: 'Volume', min: 0, max: 1, step: 0.01, value: 0.5 },
      { id: 'attack', label: 'Attack', min: 0, max: 2, step: 0.01, value: 0.01 },
      { id: 'decay', label: 'Decay', min: 0, max: 2, step: 0.01, value: 0.3 },
      { id: 'sustain', label: 'Sustain', min: 0, max: 1, step: 0.01, value: 0.7 },
      { id: 'release', label: 'Release', min: 0, max: 2, step: 0.01, value: 0.5 },
      { id: 'freqMod', label: 'Freq Mod', min: 0.5, max: 2, step: 0.01, value: 1 },
    ];

    const knobValues = {};
    knobConfig.forEach(cfg => {
      const container = document.createElement('div');
      const label = document.createElement('label');
      label.textContent = cfg.label;
      const knob = new Nexus.Knob(container, {
        size: [75, 75],
        min: cfg.min,
        max: cfg.max,
        step: cfg.step,
        value: cfg.value
      });
      knob.colorize("accent", "#2BAF90");
      knob.colorize("fill", "#0D2A35");
      knob.colorize("bright", "#F1A512");
      knob.on('change', v => { knobValues[cfg.id] = v; });
      knobValues[cfg.id] = cfg.value;
      container.appendChild(label);
      document.getElementById("knobs").appendChild(container);
    });

    const getWaveform = () => document.getElementById("waveToggle").value;

    const keys = ['a','s','d','f','g','h','j','k'];
    const freqs = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25];
    const keyMap = {};

    const keyboardDiv = document.getElementById("keyboard");

    keys.forEach((key, i) => {
      const el = document.createElement("div");
      el.className = "key";
      el.textContent = key.toUpperCase();
      keyboardDiv.appendChild(el);
      keyMap[key] = { freq: freqs[i], el };
    });

    let activeOscs = {};

    function playNote(key) {
      if (!keyMap[key] || activeOscs[key]) return;
      const osc = audioCtx.createOscillator();
      const env = audioCtx.createGain();

      osc.type = getWaveform();
      osc.frequency.value = keyMap[key].freq * knobValues.freqMod;
      keyMap[key].el.classList.add("active");

      osc.connect(env);
      env.connect(analyser);

      const now = audioCtx.currentTime;
      env.gain.setValueAtTime(0, now);
      env.gain.linearRampToValueAtTime(knobValues.volume, now + knobValues.attack);
      env.gain.linearRampToValueAtTime(knobValues.sustain, now + knobValues.attack + knobValues.decay);

      osc.start(now);
      activeOscs[key] = { osc, env };
    }

    function stopNote(key) {
      const data = activeOscs[key];
      if (!data) return;
      const now = audioCtx.currentTime;
      data.env.gain.cancelScheduledValues(now);
      data.env.gain.setTargetAtTime(0, now, knobValues.release);
      data.osc.stop(now + knobValues.release + 0.1);
      keyMap[key].el.classList.remove("active");
      delete activeOscs[key];
    }

    document.addEventListener("keydown", e => playNote(e.key));
    document.addEventListener("keyup", e => stopNote(e.key));

    const oscCanvas = document.getElementById("oscilloscope");
    const freqCanvas = document.getElementById("frequency");
    const oscCtx = oscCanvas.getContext("2d");
    const freqCtx = freqCanvas.getContext("2d");
    const timeData = new Uint8Array(analyser.fftSize);
    const freqData = new Uint8Array(analyser.frequencyBinCount);

    function draw() {
      requestAnimationFrame(draw);

      analyser.getByteTimeDomainData(timeData);
      oscCtx.fillStyle = "#000";
      oscCtx.fillRect(0, 0, oscCanvas.width, oscCanvas.height);
      oscCtx.strokeStyle = "#F1A512";
      oscCtx.beginPath();
      for (let i = 0; i < timeData.length; i++) {
        let x = i / timeData.length * oscCanvas.width;
        let y = timeData[i] / 255 * oscCanvas.height;
        if (i === 0) oscCtx.moveTo(x, y);
        else oscCtx.lineTo(x, y);
      }
      oscCtx.stroke();

      analyser.getByteFrequencyData(freqData);
      freqCtx.fillStyle = "#000";
      freqCtx.fillRect(0, 0, freqCanvas.width, freqCanvas.height);
      freqCtx.fillStyle = "#2BAF90";
      for (let i = 0; i < freqData.length; i++) {
        let x = i / freqData.length * freqCanvas.width;
        let y = freqCanvas.height - (freqData[i] / 255 * freqCanvas.height);
        freqCtx.fillRect(x, y, 2, freqCanvas.height - y);
      }
    }

    draw();
  </script>
</body>
</html>
